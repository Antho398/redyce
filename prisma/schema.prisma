// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String   // Hashé en production
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects Project[]
  messages ChatMessage[]

  @@map("users")
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents  Document[]
  memories   Memory[]
  messages   ChatMessage[]
  dpgfExtracts DPGFStructured[]
  cctpGenerated CCTPGenerated[]

  @@map("projects")
}

model Document {
  id          String   @id @default(cuid())
  name        String
  fileName    String
  filePath    String
  fileSize    Int
  mimeType    String
  documentType String? // CCTP, DPGF, RC, CCAP, etc.
  projectId   String
  status      String   @default("uploaded") // uploaded, processing, processed, error
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project        Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  analyses       DocumentAnalysis[]
  knowledgeChunks KnowledgeChunk[]
  dpgfExtracts   DPGFStructured[]

  @@index([projectId])
  @@index([documentType])
  @@map("documents")
}

model DocumentAnalysis {
  id          String   @id @default(cuid())
  documentId  String
  analysisType String  // extraction, summary, qa, etc.
  status      String   @default("pending") // pending, processing, completed, error
  result      Json?    // Résultat de l'analyse structuré
  error       String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([status])
  @@map("document_analyses")
}

model Memory {
  id          String   @id @default(cuid())
  projectId   String
  title       String
  content     String   @db.Text
  status      String   @default("draft") // draft, generating, completed, error
  version     Int      @default(1)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("memories")
}

model ChatMessage {
  id          String   @id @default(cuid())
  userId      String
  projectId   String?
  role        String   // user, assistant, system
  content     String   @db.Text
  metadata    Json?
  createdAt   DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@map("chat_messages")
}

model KnowledgeChunk {
  id          String   @id @default(cuid())
  documentId  String
  content     String   @db.Text
  embedding   String?  @db.Text // Vector embedding pour recherche sémantique
  metadata    Json?
  createdAt   DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@map("knowledge_chunks")
}

model DPGFStructured {
  id          String   @id @default(cuid())
  projectId   String
  documentId  String?  // Document source duquel le DPGF a été extrait
  title       String
  reference   String?
  dateCreation DateTime?
  
  // Données structurées extraites
  data        Json     // Structure complète : articles, matériaux, prescriptions
  
  // Métadonnées
  status      String   @default("extracted") // extracted, validated, archived
  confidence  Float?   // Score de confiance de l'extraction (0-1)
  metadata    Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  document Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)
  cctpGenerated CCTPGenerated[]

  @@index([projectId])
  @@index([documentId])
  @@index([status])
  @@map("dpgf_structured")
}

model CCTPGenerated {
  id          String   @id @default(cuid())
  projectId   String
  dpgfId      String?  // DPGF source utilisé pour générer le CCTP
  title       String
  reference   String?
  
  // Contenu généré
  content     String   @db.Text // Contenu complet du CCTP
  structure   Json     // Structure organisée du CCTP
  
  // Métadonnées
  status      String   @default("draft") // draft, generated, finalized, archived
  version     Int      @default(1)
  metadata    Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  dpgf    DPGFStructured? @relation(fields: [dpgfId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([dpgfId])
  @@index([status])
  @@map("cctp_generated")
}

